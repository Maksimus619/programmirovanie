#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_err.h"
#include "driver/i2c_master.h"
#include "driver/gpio.h"

#define I2C_TIMEOUT_VALUE_MS (50)

void app_main(void)
{
    // Настройка кнопки BOOT (GPIO0)
    gpio_set_direction(GPIO_NUM_0, GPIO_MODE_INPUT);
    gpio_pullup_en(GPIO_NUM_0);

    // Настройка I2C шины (SCL=22, SDA=21)
    i2c_master_bus_config_t i2c_mst_config = {
        .clk_source = I2C_CLK_SRC_DEFAULT,
        .i2c_port = I2C_NUM_0,
        .scl_io_num = GPIO_NUM_22,
        .sda_io_num = GPIO_NUM_21,
        .glitch_ignore_cnt = 7,
        .flags.enable_internal_pullup = true, // Включить внутренние подтяжки
    };
    i2c_master_bus_handle_t bus_handle;
    ESP_ERROR_CHECK(i2c_new_master_bus(&i2c_mst_config, &bus_handle));

    printf("Готово! Нажмите кнопку BOOT (GPIO0), чтобы просканировать I2C-шину.\n");

    while (1)
    {
        if (gpio_get_level(GPIO_NUM_0) == 0)  // кнопка нажата
        {
            printf("\n\nСканирование I2C-шины...\n");
            printf("     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f\n");

            uint8_t found_devices = 0;
            
            for (int i = 0; i < 128; i += 16)
            {
                printf("%02x: ", i);
                for (int j = 0; j < 16; j++)
                {
                    uint8_t addr = i + j;
                    
                    // Пропускаем зарезервированные адреса
                    if (addr == 0x00 || addr > 0x77) {
                        printf("   ");
                        continue;
                    }
                    
                    // Создаем временное устройство для проверки
                    i2c_device_config_t dev_cfg = {
                        .dev_addr_length = I2C_ADDR_BIT_LEN_7,
                        .device_address = addr,
                        .scl_speed_hz = 100000,
                    };
                    
                    i2c_master_dev_handle_t dev_handle;
                    esp_err_t ret = i2c_master_bus_add_device(bus_handle, &dev_cfg, &dev_handle);
                    
                    if (ret == ESP_OK) {
                        // Пробуем прочитать байт
                        uint8_t data;
                        ret = i2c_master_receive(dev_handle, &data, 1, I2C_TIMEOUT_VALUE_MS);
                        
                        if (ret == ESP_OK) {
                            printf("%02x ", addr);
                            found_devices++;
                        } else {
                            printf("-- ");
                        }
                        
                        // Удаляем устройство
                        i2c_master_bus_rm_device(dev_handle);
                    } else {
                        printf("-- ");
                    }
                }
                printf("\n");
            }
            
            printf("\nНайдено устройств: %d\n", found_devices);
            
            // Ожидаемые адреса:
            printf("Ожидаемые адреса:\n");
            printf(" - MPU-6050: 0x68 или 0x69\n");
            printf(" - OLED: 0x3C\n");
            printf(" - RTC: 0x68\n");

            // Ждём, пока кнопку отпустят
            while (gpio_get_level(GPIO_NUM_0) == 0)
            {
                vTaskDelay(pdMS_TO_TICKS(10));
            }
        }

        vTaskDelay(pdMS_TO_TICKS(20));
    }
}