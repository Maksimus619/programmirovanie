#include <mpi.h>
#include <stdio.h>
#include <stdlib.h>

#define MB (1024 * 1024)   // Определяем размер 1 МБ
#define KB 1024            // Определяем размер 1 КБ
#define BYTE 1             // Определяем размер 1 байт

int main(int argc, char *argv[]) {
    int rank, size, prev, next;
    char *message;
    MPI_Status status;

    // Инициализация MPI
    MPI_Init(&argc, &argv);
    MPI_Comm_rank(MPI_COMM_WORLD, &rank);  // Получаем ранг текущего процесса
    MPI_Comm_size(MPI_COMM_WORLD, &size);  // Получаем количество процессов

    // Определяем соседей в кольце
    prev = (rank - 1 + size) % size;  // Предыдущий процесс
    next = (rank + 1) % size;         // Следующий процесс

    // Выделяем память под сообщение (1 МБ)
    message = (char *)malloc(MB * sizeof(char));

    // Инициализация сообщения (например, заполняем нулями)
    for (int i = 0; i < MB; i++) {
        message[i] = 0;
    }

    // Переменная для измерения времени
    double start_time, end_time;

    // Начало обмена
    start_time = MPI_Wtime();

    for (int i = 0; i < size - 1; i++) {
        if (rank % 2 == 0) {
            // Четные процессы сначала отправляют, потом получают
            MPI_Send(message, MB, MPI_CHAR, next, 0, MPI_COMM_WORLD);
            MPI_Recv(message, MB, MPI_CHAR, prev, 0, MPI_COMM_WORLD, &status);
        } else {
            // Нечетные процессы сначала получают, потом отправляют
            MPI_Recv(message, MB, MPI_CHAR, prev, 0, MPI_COMM_WORLD, &status);
            MPI_Send(message, MB, MPI_CHAR, next, 0, MPI_COMM_WORLD);
        }
    }

    // Конец обмена
    end_time = MPI_Wtime();

    // Вывод времени выполнения на процессе 0
    if (rank == 0) {
        printf("Время выполнения обмена: %f секунд\n", end_time - start_time);
    }

    // Освобождаем память
    free(message);

    // Завершение работы MPI
    MPI_Finalize();

    return 0;
}
